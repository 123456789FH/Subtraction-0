
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø·Ø±Ø­ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£ØµÙØ§Ø± (Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap');
    * { font-family: "Tajawal", system-ui, sans-serif; }
    .card { box-shadow: 0 18px 60px rgba(15,23,42,.12); }
    .box3 {
      border-width: 4px; border-radius: 18px;
      min-width: 78px; min-height: 78px;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:40px; background:#fff;
      /* Ø§Ø¬Ø¹Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ³Ù…Ø­ Ø¨Ø¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… ÙÙˆÙ‚Ù‡ */
      position:relative; overflow:visible;
    }
    
/* Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø±Ù‡ */
.d-old.strike{
  color:#94a3b8;
  text-decoration: line-through;
}

/* Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù) ÙÙˆÙ‚ Ø§Ù„Ø®Ø§Ù†Ø© */
.mark-new{
  position:absolute;
  top:-28px;
  left:50%;
  transform:translateX(-50%);
  font-size:22px;
  font-weight:800;
  color:#7c3aed;
  background:#fff;
  padding:0 8px;
  border-radius:12px;
  border:2px solid rgba(139,92,246,.35);
  line-height:1.2;
}

/* Ø±Ù‚Ù… ÙˆØ³ÙŠØ· (Ù…Ø«Ù„ 10 ÙÙˆÙ‚ Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ø«Ù… ÙŠÙØ´Ø·Ø¨) */
  .mark-mid{
  position:absolute;
  top:-54px;
  left:50%;
  transform:translateX(-50%);
  font-size:18px;
  font-weight:800;
  color:#64748b;
  background:#fff;
  padding:0 6px;
  border-radius:12px;
  border:2px solid rgba(148,163,184,.35);
  text-decoration: line-through;
  line-height:1.2;
  }

  /* Ø´Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù‡Ù… */
.borrowArrow{
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  font-size:.78rem;
  font-weight:800;
  color:#b45309;
  background:#fff7ed;
  border:2px solid #fed7aa;
  padding:2px 10px;
  border-radius:999px;
}

/* Ø±Ø³Ø§Ø¦Ù„ ØªØµØ­ÙŠØ­ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù */
.borrowMsgGood{ color:#047857; }
.borrowMsgBad{ color:#b91c1c; }

    .ansBox{
      width: 5rem; height: 4.25rem; text-align:center;
      font-size:2rem; font-weight:800; border-width:4px;
      border-radius:1.25rem; outline:none; background:#fff;
    }
    .ansBox:focus{ box-shadow:0 0 0 6px rgba(236,72,153,.25); }
    .borrowBox{
      width:3.25rem; height:2.75rem; text-align:center;
      font-size:1.35rem; font-weight:800; border-width:3px;
      border-radius:.9rem; outline:none; background:#fff; opacity:.95;
    }
    .borrowBox:focus{ box-shadow:0 0 0 5px rgba(139,92,246,.22); }
    .btn{ border-radius:18px; font-weight:800; padding:14px 18px; }
    .shake{ animation:shake .35s ease-in-out; }
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(6px)}50%{transform:translateX(-6px)}75%{transform:translateX(4px)}}
    .pop{ animation:pop .35s ease-in-out; }
    @keyframes pop{0%{transform:scale(.98)}60%{transform:scale(1.04)}100%{transform:scale(1)}}
    @media (max-width:640px){
      .box3{min-width:68px; min-height:68px; font-size:34px}
      .ansBox{width:4.25rem; height:3.75rem; font-size:1.75rem}
      .borrowBox{width:2.8rem; height:2.4rem; font-size:1.2rem}
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-amber-50 via-white to-emerald-50">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <div class="bg-white/90 backdrop-blur rounded-3xl card p-6 border border-emerald-100">
      <div class="flex flex-col gap-2 items-center text-center">
        <div class="text-2xl md:text-3xl font-extrabold text-slate-800">Ø§Ù„Ø·Ù‘ÙØ±Ù’Ø­Ù Ù…ÙØ¹Ù ÙˆÙØ¬ÙÙˆØ¯Ù Ø§Ù„Ø£ÙØµÙ’ÙÙØ§Ø±</div>
        <div class="mt-1 inline-block rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3">
          <div class="font-extrabold text-emerald-800">ÙÙÙƒÙ’Ø±ÙØ©Ù Ø§Ù„Ø¯Ù‘ÙØ±Ù’Ø³Ù</div>
          <div class="text-slate-700 font-bold mt-1">Ø£Ø·Ø±Ø­Ù Ø£Ø¹Ø¯Ø§Ø¯Ù‹Ø§ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£ØµÙØ§Ø±.</div>
        </div>
        <div class="text-sm md:text-base text-slate-600 mt-1">
          Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ø£Ùˆ Ø§Ù„Ø¢Ø­Ø§Ø¯ (Ù )ØŒ ÙˆØ¹Ù†Ø¯Ù‡Ø§ Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù) Ø¹Ø¨Ø± Ø§Ù„ØµÙØ±.
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-2 justify-center">
        <button id="tab-learn" class="btn bg-pink-600 text-white">ØªØ¹Ù„Ù…</button>
        <button id="tab-example" class="btn bg-white text-slate-700 border-2 border-pink-200">Ù…Ø«Ø§Ù„ Ù…Ø­Ù„ÙˆÙ„</button>
        <button id="tab-practice" class="btn bg-white text-slate-700 border-2 border-pink-200">ØªØ¯Ø±Ø¨</button>
      </div>
    </div>

    <div class="mt-6">
      <section id="section-learn" class="bg-white rounded-3xl card p-6 border border-emerald-100">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="rounded-2xl p-4 bg-pink-50 border border-pink-100">
            <div class="font-extrabold text-lg text-slate-800 mb-2">Ù¡) Ø£Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø¢Ø­Ø§Ø¯</div>
            <div class="text-slate-700 leading-7">
              Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø­Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ <b>Ø£ØµØºØ±</b> Ù…Ù† Ø¢Ø­Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙÙ„ÙŠØŒ Ø£Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª.
            </div>
          </div>
          <div class="rounded-2xl p-4 bg-purple-50 border border-purple-100">
            <div class="font-extrabold text-lg text-slate-800 mb-2">Ù¢) Ù…Ø§Ø°Ø§ Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ø´Ø±Ø§Øª = Ù ØŸ</div>
            <div class="text-slate-700 leading-7">
              Ø¥Ø°Ø§ Ø§Ø­ØªØ¬ØªÙ Ø§Ø³ØªÙ„Ø§ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª ÙˆÙƒØ§Ù†Øª <b>Ù </b>:
              Ø£Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª Ø£ÙˆÙ„Ù‹Ø§ØŒ ÙØªÙØµØ¨Ø­ Ø§Ù„Ø¹Ø´Ø±Ø§Øª <b>Ù¡Ù </b>ØŒ Ø«Ù… Ø£Ø³ØªÙ„Ù Ù¡ Ù„Ù„Ø¹Ø´Ø±Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¢Ø­Ø§Ø¯.
              ØºØ§Ù„Ø¨Ù‹Ø§ ØªØµØ¨Ø­ Ø§Ù„Ø¹Ø´Ø±Ø§Øª <b>Ù©</b>.
            </div>
          </div>
          <div class="rounded-2xl p-4 bg-amber-50 border border-amber-100">
            <div class="font-extrabold text-lg text-slate-800 mb-2">Ù£) Ø«Ù… Ø§Ù„Ø¹Ø´Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø¦Ø§Øª</div>
            <div class="text-slate-700 leading-7">
              Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ù†ÙÙƒÙ…Ù„: Ù†Ø·Ø±Ø­ Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ø«Ù… Ø§Ù„Ù…Ø¦Ø§ØªØŒ ÙˆÙ†ÙƒØªØ¨ Ø§Ù„Ù†Ø§ØªØ¬ ÙÙŠ Ø®Ø§Ù†Ø§Øª (Ù…Ø¦Ø§Øª/Ø¹Ø´Ø±Ø§Øª/Ø¢Ø­Ø§Ø¯).
            </div>
          </div>
        </div>

        <div class="mt-5 rounded-2xl p-4 border border-slate-200 bg-slate-50">
          <div class="font-extrabold text-slate-800 mb-2">Ù…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ø¹Ø¨Ø± Ø§Ù„ØµÙØ± âœ…</div>
          <div class="text-slate-700 leading-7">
            <b>Ù¤Ù Ù¢ âˆ’ Ù¡Ù§Ù¨</b>:
            Ø§Ù„Ø¢Ø­Ø§Ø¯ Ù¢ Ø£ØµØºØ± Ù…Ù† Ù¨ â†’ Ù†Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù„ÙƒÙ† Ø§Ù„Ø¹Ø´Ø±Ø§Øª = Ù  â†’ Ù†Ø³ØªÙ„Ù Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª (Ù¤ ØªØµØ¨Ø­ Ù£ØŒ Ø§Ù„Ø¹Ø´Ø±Ø§Øª ØªØµØ¨Ø­ Ù¡Ù )ØŒ Ø«Ù… Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù„Ù„Ø¢Ø­Ø§Ø¯ ÙØªÙØµØ¨Ø­ Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù© ÙˆØ§Ù„Ø¢Ø­Ø§Ø¯ Ù¡Ù¢.
          </div>
        </div>
      </section>

      <section id="section-example" class="hidden bg-white rounded-3xl card p-6 border border-emerald-100">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="font-extrabold text-xl text-slate-800">Ù…Ø«Ø§Ù„ Ù…Ø­Ù„ÙˆÙ„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© (Ù…Ø¹ Ø£ØµÙØ§Ø±)</div>
          <button id="btnNewExample" class="btn bg-purple-600 text-white">Ù…Ø«Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="mt-5 rounded-3xl border border-slate-200 bg-slate-50 p-5">
        <div id="exampleEq" class="flex flex-col items-center gap-2"></div>
          <div id="exampleGrid" class="flex flex-col items-center gap-4 mt-4"></div>
          <div class="mt-4 rounded-2xl bg-white border border-slate-200 p-4" id="exampleSteps"></div>
        </div>
      </section>

      <section id="section-practice" class="hidden bg-white rounded-3xl card p-6 border border-emerald-100">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="font-extrabold text-xl text-slate-800">ØªØ¯Ø±Ø¨: Ø§ÙƒØªØ¨ Ø§Ù„Ù†Ø§ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª</div>
            <div class="text-slate-600">Ø±ÙƒÙ‘Ø²/ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ±: Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ø¹Ø¨Ø± Ø§Ù„ØµÙØ±.</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-200 px-4 py-3">
            <div class="font-bold text-slate-700">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
            <div class="text-slate-700">â­ <span id="score">Ù </span> / <span id="total">Ù </span></div>
          </div>
        </div>

        <div class="mt-6 grid lg:grid-cols-2 gap-6 items-start">
          <div class="rounded-3xl border border-pink-100 bg-gradient-to-b from-white to-pink-50 p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="font-extrabold text-slate-800">Ø§Ù„Ù…Ø³Ø£Ù„Ø©</div>
              <div class="text-sm text-slate-500">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø¢Ø­Ø§Ø¯</div>
            </div>

            <div id="practiceProblem" class="flex flex-col items-center gap-4"></div>

            <div class="mt-5 flex flex-col items-center gap-3">
              <div class="text-2xl font-extrabold text-slate-800">= ØŸ</div>
              <div class="flex items-center justify-center gap-4" dir="ltr">
                <div class="text-center">
                  <div class="text-sm font-bold text-gray-500 mb-1">Ù…Ø¦Ø§Øª</div>
                  <input id="ans-h" class="ansBox border-pink-500 text-slate-800" inputmode="numeric" maxlength="1" />
                </div>
                <div class="text-center">
                  <div class="text-sm font-bold text-gray-500 mb-1">Ø¹Ø´Ø±Ø§Øª</div>
                  <input id="ans-t" class="ansBox border-pink-500 text-slate-800" inputmode="numeric" maxlength="1" />
                </div>
                <div class="text-center">
                  <div class="text-sm font-bold text-gray-500 mb-1">Ø¢Ø­Ø§Ø¯</div>
                  <input id="ans-o" class="ansBox border-pink-500 text-slate-800" inputmode="numeric" maxlength="1" />
                </div>
              </div>
              <div class="text-sm text-slate-500">Ø§ÙƒØªØ¨ÙŠ ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ù…Ø±Ø¨Ø¹Ù‡</div>
            </div>

            <div class="mt-5 flex gap-3 justify-center flex-wrap">
                <button id="btnCheck" class="btn bg-emerald-600 text-white w-44">ØªØ­Ù‚Ù‚ âœ…</button>
                 <button id="btnSolve" class="btn bg-white border-2 border-purple-200 text-slate-700 w-44">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„</button>
                 <button id="btnBack" class="btn bg-white border-2 border-slate-200 text-slate-700 w-44">Ø±Ø¬ÙˆØ¹ â†©ï¸</button>
                 <button id="btnStep" class="btn bg-white border-2 border-amber-200 text-slate-700 w-44">Ø®Ø·ÙˆØ© Ø®Ø·ÙˆØ©</button>
            </div>          



            <div class="mt-4 flex gap-3 justify-center">
              <button id="btnNewQ" class="btn bg-purple-600 text-white w-44">Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
              <select id="mode" class="btn bg-white border-2 border-slate-200 text-slate-700 w-44">
                <option value="mix">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
                <option value="zeros">Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø£ØµÙØ§Ø±</option>
                <option value="zerosBorrow">Ø£ØµÙØ§Ø± + Ø§Ø³ØªÙ„Ø§Ù</option>
              </select>
            </div>
          </div>

          <div class="rounded-3xl border border-slate-200 bg-white p-5">
            <div class="font-extrabold text-slate-800 mb-2">Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø´Ø±Ø­</div>
            <div id="feedback" class="text-slate-700 leading-7">
              Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù†Ø§ØªØ¬ Ø«Ù… Ø§Ø¶ØºØ·ÙŠ <b>ØªØ­Ù‚Ù‚</b>. Ø§Ø¶ØºØ·ÙŠ <b>Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„</b> Ù„Ø±Ø¤ÙŠØ© Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù (Ø®ØµÙˆØµÙ‹Ø§ Ø¹Ø¨Ø± Ø§Ù„ØµÙØ±).
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="mt-8 text-center text-slate-600">
      <div class="bg-white/80 inline-block px-4 py-3 rounded-2xl border border-slate-200">
        <span class="font-bold">Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ</span> â€¢ Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€¢ Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
      </div>
    </div>
  </div>

  <script>
    const arabic = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
    const toArabic = (n) => String(Math.trunc(n)).split('').map(ch=>{
      const d = ch.charCodeAt(0)-48;
      return (d>=0 && d<=9) ? arabic[d] : ch;
    }).join('');

    const normDigits = (str) => {
      if (str == null) return "";
      const s = String(str).trim();
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      return s.split('').map(ch => map[ch] ?? ch).join('');
    };

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    // Tabs
    const tabs = [
      {btn:'tab-learn', sec:'section-learn'},
      {btn:'tab-example', sec:'section-example'},
      {btn:'tab-practice', sec:'section-practice'},
    ];
    function setTab(active){
      tabs.forEach(t=>{
        const b=document.getElementById(t.btn);
        const s=document.getElementById(t.sec);
        const on=t.btn===active;
        s.classList.toggle('hidden', !on);
        b.className = on ? 'btn bg-pink-600 text-white' : 'btn bg-white text-slate-700 border-2 border-pink-200';
      });
    }
    document.getElementById('tab-learn').onclick=()=>setTab('tab-learn');
    document.getElementById('tab-example').onclick=()=>setTab('tab-example');
    document.getElementById('tab-practice').onclick=()=>setTab('tab-practice');

    // Simulate subtraction and detect borrow through zero (tens==0 while borrowing for ones)
     // Simulate subtraction + produce "work" info to SHOW borrowing on the grid
function simulate(top, bot){
  // original digits (top)
  const hOld = Math.floor(top/100);
  const tOld = Math.floor((top%100)/10);
  const oOld = top%10;

  // bottom digits
  const h2 = Math.floor(bot/100);
  const t2 = Math.floor((bot%100)/10);
  const o2 = bot%10;

  let h = hOld, t = tOld, o = oOld;

  const log = [];
  const work = {
  hOld, tOld, oOld,
  hNew: hOld, tNew: tOld, oNew: oOld,
  tMid: null,                 // Ù…Ø«Ù„ 10 ÙÙˆÙ‚ Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ø«Ù… ØªÙØ´Ø·Ø¨
  changed: {h:false, t:false, o:false},
  borrowOnes:false,
  borrowTens:false,
  throughZero:false,          // Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù â€œÙ…Ù† Ù…ÙƒØ§Ù† ÙÙŠÙ‡ ØµÙØ±â€
  expectBorrowH: null,        // Ù…Ø§ ÙŠÙƒØªØ¨ ÙÙŠ Ø®Ø§Ù†Ø© (Ø§Ø³ØªÙ„Ø§Ù Ù…Ø¦Ø§Øª)
  expectBorrowT: null         // Ù…Ø§ ÙŠÙƒØªØ¨ ÙÙŠ Ø®Ø§Ù†Ø© (Ø§Ø³ØªÙ„Ø§Ù Ø¹Ø´Ø±Ø§Øª)
};


  // 1) Ones
  if (o < o2){
    work.borrowOnes = true;
    log.push(`Ø¢Ø­Ø§Ø¯: ${toArabic(o)} Ø£ØµØºØ± Ù…Ù† ${toArabic(o2)} â†’ Ù†Ø­ØªØ§Ø¬ Ø§Ø³ØªÙ„Ø§ÙÙ‹Ø§.`);

    if (t === 0){
      work.throughZero = true;
      log.push(`Ø§Ù„Ø¹Ø´Ø±Ø§Øª = ${toArabic(0)} (ØµÙØ±) â†’ Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.`);
      h -= 1;
      t += 10;                 // now tens is 10
      if (work.expectBorrowH == null) work.expectBorrowH = t; // Ù…Ø«Ù„ 10 Ø£Ùˆ 13...
      work.hNew = h; work.changed.h = true;
      work.tMid = t;           // show 10 as crossed intermediate
      log.push(`Ù†ÙƒØªØ¨ ${toArabic(10)} ÙÙˆÙ‚ Ø§Ù„Ø¹Ø´Ø±Ø§ØªØŒ ÙˆØªØµØ¨Ø­ Ø§Ù„Ù…Ø¦Ø§Øª ${toArabic(h)}.`);
    }

    // borrow 1 ten to ones
    t -= 1;
    o += 10;
    work.expectBorrowT = o; // Ù…Ø«Ù„ 12
    work.tNew = t; work.oNew = o;
    work.changed.t = (t !== tOld);
    work.changed.o = true;

    log.push(`Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù„Ù„Ø¢Ø­Ø§Ø¯ â†’ Ø§Ù„Ø¹Ø´Ø±Ø§Øª ØªØµØ¨Ø­ ${toArabic(t)} ÙˆØ§Ù„Ø¢Ø­Ø§Ø¯ ØªØµØ¨Ø­ ${toArabic(o)}.`);
  }

  const rOnes = o - o2;
  log.push(`Ù†Ø§ØªØ¬ Ø§Ù„Ø¢Ø­Ø§Ø¯: ${toArabic(o)} âˆ’ ${toArabic(o2)} = ${toArabic(rOnes)}.`);

  // 2) Tens
  if (t < t2){
    work.borrowTens = true;
    log.push(`Ø¹Ø´Ø±Ø§Øª: ${toArabic(t)} Ø£ØµØºØ± Ù…Ù† ${toArabic(t2)} â†’ Ù†Ø­ØªØ§Ø¬ Ø§Ø³ØªÙ„Ø§ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª.`);

    // Ù‡Ù†Ø§ Ø£ÙŠØ¶Ù‹Ø§ Ù‚Ø¯ ÙŠÙƒÙˆÙ† t = 0 (Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù Ø§Ù„Ø¢Ø­Ø§Ø¯) ÙÙŠØ´Ø¹Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ù†Ù‡Ø§ â€œØ¹Ø¨Ø± Ø§Ù„ØµÙØ±â€
    if (t === 0) work.throughZero = true;

    h -= 1;
    t += 10;                  // add 10 tens
    work.expectBorrowH = t; // ØºØ§Ù„Ø¨Ù‹Ø§ 10
    work.hNew = h; work.tNew = t;
    work.changed.h = (h !== hOld);
    work.changed.t = true;

    log.push(`Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª â†’ Ø§Ù„Ù…Ø¦Ø§Øª ØªØµØ¨Ø­ ${toArabic(h)} ÙˆØ§Ù„Ø¹Ø´Ø±Ø§Øª ØªØµØ¨Ø­ ${toArabic(t)}.`);
  }

  const rTens = t - t2;
  log.push(`Ù†Ø§ØªØ¬ Ø§Ù„Ø¹Ø´Ø±Ø§Øª: ${toArabic(t)} âˆ’ ${toArabic(t2)} = ${toArabic(rTens)}.`);

  // 3) Hundreds
  const rHundreds = h - h2;
  log.push(`Ù†Ø§ØªØ¬ Ø§Ù„Ù…Ø¦Ø§Øª: ${toArabic(h)} âˆ’ ${toArabic(h2)} = ${toArabic(rHundreds)}.`);

  const answer = rHundreds*100 + rTens*10 + rOnes;
  return {answer, log, rHundreds, rTens, rOnes, work};
}


    function gen(mode='mix'){
  for (let attempt=0; attempt<900; attempt++){
    let top = randInt(100, 999);
    let bot = randInt(10, 999);
    if (bot > top) [top, bot] = [bot, top];

    const h1=Math.floor(top/100), t1=Math.floor((top%100)/10), o1=top%10;
    const hasZero = (t1===0 || o1===0);

    const sim = simulate(top, bot);
    if (sim.answer < 0) continue;

    // Ù‡Ù„ Ø­ØµÙ„ Ø§Ø³ØªÙ„Ø§Ù ÙØ¹Ù„Ø§Ù‹ØŸ
    const hasBorrow = sim.work.borrowOnes || sim.work.borrowTens;

    if (mode==='zeros'){
      if (!hasZero) continue;
    }

    // "Ø£ØµÙØ§Ø± + Ø§Ø³ØªÙ„Ø§Ù" = ÙŠÙˆØ¬Ø¯ ØµÙØ± + ÙŠÙˆØ¬Ø¯ Ø§Ø³ØªÙ„Ø§Ù (Ø³ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ø¢Ø­Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ø¹Ø´Ø±Ø§Øª)
    if (mode==='zerosBorrow'){
      if (!hasZero) continue;
      if (!hasBorrow) continue;
    }

    return {
      top, bot, ...sim,
      h1,t1,o1,
      h2:Math.floor(bot/100), t2:Math.floor((bot%100)/10), o2:bot%10
    };
  }

  // fallback
  const top = 402, bot = 178;
  const sim = simulate(top, bot);
  return {top, bot, ...sim, h1:4,t1:0,o1:2, h2:1,t2:7,o2:8};
}

    function renderProblem(targetId, q, opts = {}) {
  const el = document.getElementById(targetId);
  const prefix = opts.prefix ?? targetId;
  const showBorrowInputs = opts.showBorrowInputs ?? true;

  // Ù‡Ù„ Ù†Ø­ØªØ§Ø¬ Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø³Ù‡Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§ÙØŸ
  const needH2T = (q && q.work && q.work.expectBorrowH != null); // Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø´Ø±Ø§Øª
  const needT2O = (q && q.work && q.work.expectBorrowT != null); // Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¢Ø­Ø§Ø¯

  // Ù†Ø¨Ù†ÙŠ HTML Ø§Ù„Ø£Ø³Ù‡Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ø¨Ø¯ÙˆÙ† hidden)
  const arrowH2T = needH2T
    ? `<div class="borrowArrow mt-1" data-arrow="h2t">Ù…Ø¦Ø§Øª âœ Ø¹Ø´Ø±Ø§Øª</div>`
    : ``;

  const arrowT2O = needT2O
    ? `<div class="borrowArrow mt-1" data-arrow="t2o">Ø¹Ø´Ø±Ø§Øª âœ Ø¢Ø­Ø§Ø¯</div>`
    : ``;

  const borrowRow = showBorrowInputs ? `
    <div class="grid grid-cols-3 gap-4 items-end justify-items-center" dir="ltr">
      <div class="text-center">
        <div class="text-sm font-bold text-gray-500 mb-1">â€”</div>
        <div class="text-gray-400 text-sm"> </div>
      </div>

      <div class="text-center">
        <div class="text-sm font-bold text-gray-500 mb-1">Ø§Ø³ØªÙ„Ø§Ù (Ù…Ø¦Ø§Øª)</div>
        <input id="${prefix}-borrow-h" class="borrowBox border-purple-500 text-slate-800" inputmode="numeric" maxlength="2" />
        <div id="${prefix}-borrow-h-msg" class="text-xs font-bold mt-1"></div>
      </div>

      <div class="text-center">
        <div class="text-sm font-bold text-gray-500 mb-1">Ø§Ø³ØªÙ„Ø§Ù (Ø¹Ø´Ø±Ø§Øª)</div>
        <input id="${prefix}-borrow-t" class="borrowBox border-purple-500 text-slate-800" inputmode="numeric" maxlength="2" />
        <div id="${prefix}-borrow-t-msg" class="text-xs font-bold mt-1"></div>
      </div>
    </div>
  ` : ``;

  // digit box template (old digit + mid + new)
  const box = (place, value) => `
    <div class="box3 border-pink-500 text-slate-800" data-place="${place}">
      <span class="d-old" data-role="old">${toArabic(value)}</span>
      <span class="mark-mid hidden" data-role="mid"></span>
      <span class="mark-new hidden" data-role="new"></span>
    </div>
  `;

  el.innerHTML = `
    <div class="flex flex-col items-center gap-4">
      ${borrowRow}

      <div class="grid grid-cols-3 gap-4 items-center justify-items-center" dir="ltr">
        <div class="text-center">
          <div class="text-sm font-bold text-gray-500">Ù…Ø¦Ø§Øª</div>
          ${box('h', q.h1)}
        </div>

        <div class="text-center">
          <div class="text-sm font-bold text-gray-500">Ø¹Ø´Ø±Ø§Øª</div>
          ${arrowH2T}
          ${box('t', q.t1)}
        </div>

        <div class="text-center">
          <div class="text-sm font-bold text-gray-500">Ø¢Ø­Ø§Ø¯</div>
          ${arrowT2O}
          ${box('o', q.o1)}
        </div>
      </div>

      <div class="grid grid-cols-3 gap-4 items-center justify-items-center" dir="ltr">
        <div class="text-center">
          <div class="text-sm font-bold text-gray-500">Ù…Ø¦Ø§Øª</div>
          <div class="box3 border-pink-500 text-slate-800">${toArabic(q.h2)}</div>
        </div>

        <div class="text-center">
          <div class="text-sm font-bold text-gray-500">Ø¹Ø´Ø±Ø§Øª</div>
          <div class="box3 border-pink-500 text-slate-800">${toArabic(q.t2)}</div>
        </div>

        <div class="text-center">
          <div class="text-sm font-bold text-gray-500">Ø¢Ø­Ø§Ø¯</div>
          <div class="box3 border-pink-500 text-slate-800">${toArabic(q.o2)}</div>
        </div>
      </div>

      <div class="text-6xl font-extrabold text-pink-600">âˆ’</div>
      <div class="w-full h-1 rounded-full bg-pink-500"></div>
    </div>
  `;

  // sanitize borrow inputs (if shown)
  if (showBorrowInputs) {
    [`${prefix}-borrow-h`, `${prefix}-borrow-t`].forEach(id => {
      const bx = document.getElementById(id);
      if (!bx) return;
      bx.addEventListener('input', () => {
        bx.value = normDigits(bx.value).replace(/\D/g, '').slice(-2); // allow 10/12 etc
      });
    });
  }
}

    
function applyBorrowToGrid(containerEl, work){
  const places = ['h','t','o'];
  places.forEach(p=>{
    const box = containerEl.querySelector(`[data-place="${p}"]`);
    if (!box) return;
    const oldEl = box.querySelector('[data-role="old"]');
    const midEl = box.querySelector('[data-role="mid"]');
    const newEl = box.querySelector('[data-role="new"]');

    // reset
    oldEl.classList.remove('strike');
    midEl.classList.add('hidden'); midEl.textContent = '';
    newEl.classList.add('hidden'); newEl.textContent = '';

    // show mid only for tens when exists
    if (p==='t' && work.tMid != null){
      midEl.textContent = toArabic(work.tMid);
      midEl.classList.remove('hidden');
    }

    // show new if changed
    const changed = work.changed[p];
    if (changed){
      oldEl.classList.add('strike');
      const key = (p==='h') ? 'hNew' : (p==='t' ? 'tNew' : 'oNew');
      newEl.textContent = toArabic(work[key]);
      newEl.classList.remove('hidden');
    }
  });
}

function showBorrowArrows(containerEl, q){
  const needH2T = (q.work.expectBorrowH != null);     // Ø§Ø³ØªÙ„Ø§Ù Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª Ù„Ù„Ø¹Ø´Ø±Ø§Øª
  const needT2O = (q.work.expectBorrowT != null);     // Ø§Ø³ØªÙ„Ø§Ù Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù„Ù„Ø¢Ø­Ø§Ø¯

  const a1 = containerEl.querySelector('[data-arrow="h2t"]');
  const a2 = containerEl.querySelector('[data-arrow="t2o"]');

  if (a1) a1.classList.toggle('hidden', !needH2T);
  if (a2) a2.classList.toggle('hidden', !needT2O);
}

function readBorrowVal(id){
  const el = document.getElementById(id);
  if (!el) return "";
  return normDigits(el.value).replace(/\D/g,'');
}

function setBorrowMsg(id, html, good){
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('borrowMsgGood','borrowMsgBad');
  el.classList.add(good ? 'borrowMsgGood' : 'borrowMsgBad');
  el.innerHTML = html;
}

// ØªØ±Ø¬Ø¹ true Ø¥Ø°Ø§ ÙƒÙ„ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù ØµØ­ÙŠØ­Ø© (Ø£Ùˆ ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø©)
function updateBorrowHints(prefix, q, opts={reveal:false}){
  const expH = q.work.expectBorrowH; // tens after borrowing from hundreds
  const expT = q.work.expectBorrowT; // ones after borrowing from tens

  const idH = `${prefix}-borrow-h`;
  const idT = `${prefix}-borrow-t`;

  const msgH = `${prefix}-borrow-h-msg`;
  const msgT = `${prefix}-borrow-t-msg`;

  // reveal mode: Ø§Ù…Ù„Ø£ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„)
  if (opts.reveal){
    const elH = document.getElementById(idH);
    const elT = document.getElementById(idT);
    if (elH && expH != null) elH.value = String(expH);
    if (elT && expT != null) elT.value = String(expT);
  }

  const vH = readBorrowVal(idH);
  const vT = readBorrowVal(idT);

  let okAll = true;

  // ====== H (Ø§Ø³ØªÙ„Ø§Ù Ù…Ø¦Ø§Øª) ======
  if (expH == null){
    if (vH !== ""){
      okAll = false;
      setBorrowMsg(msgH, `Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø§Ø³ØªÙ„Ø§ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª Ù‡Ù†Ø§ âœ‹`, false);
    } else {
      setBorrowMsg(msgH, ``, true);
    }
  } else {
    if (vH === ""){
      okAll = false;
      setBorrowMsg(msgH, `Ø§ÙƒØªØ¨ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù (Ù…Ø«Ù„ ${toArabic(expH)})`, false);
    } else if (parseInt(vH,10) === expH){
      setBorrowMsg(msgH, `âœ… ØµØ­ÙŠØ­`, true);
    } else {
      okAll = false;
      setBorrowMsg(msgH, `âŒ Ø¬Ø±Ù‘Ø¨ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (ØªÙ„Ù…ÙŠØ­: Ø§Ù„Ø¹Ø´Ø±Ø§Øª ØªØµØ¨Ø­ ${toArabic(expH)})`, false);
    }
  }

  // ====== T (Ø§Ø³ØªÙ„Ø§Ù Ø¹Ø´Ø±Ø§Øª) ======
  if (expT == null){
    if (vT !== ""){
      okAll = false;
      setBorrowMsg(msgT, `Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø§Ø³ØªÙ„Ø§ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù‡Ù†Ø§ âœ‹`, false);
    } else {
      setBorrowMsg(msgT, ``, true);
    }
  } else {
    if (vT === ""){
      okAll = false;
      setBorrowMsg(msgT, `Ø§ÙƒØªØ¨ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¢Ø­Ø§Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù (Ù…Ø«Ù„ ${toArabic(expT)})`, false);
    } else if (parseInt(vT,10) === expT){
      setBorrowMsg(msgT, `âœ… ØµØ­ÙŠØ­`, true);
    } else {
      okAll = false;
      setBorrowMsg(msgT, `âŒ ØªÙ„Ù…ÙŠØ­: Ø§Ù„Ø¢Ø­Ø§Ø¯ ØªØµØ¨Ø­ ${toArabic(expT)}`, false);
    }
  }

  return okAll;
}

function attachBorrowTrainer(prefix, q){
  const bh = document.getElementById(`${prefix}-borrow-h`);
  const bt = document.getElementById(`${prefix}-borrow-t`);
  if (bh){
    bh.addEventListener('input', ()=> updateBorrowHints(prefix, q));
    bh.addEventListener('blur',  ()=> updateBorrowHints(prefix, q));
  }
  if (bt){
    bt.addEventListener('input', ()=> updateBorrowHints(prefix, q));
    bt.addEventListener('blur',  ()=> updateBorrowHints(prefix, q));
  }

  // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ + Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ù‡Ù…
   updateBorrowHints(prefix, q);
   showBorrowArrows(document.getElementById('practiceProblem'), q);
   }

     // =======================
// Step-by-step Borrowing (Notebook style + Back)
// =======================
let borrowStepper = null;

function resetMarks(containerEl){
  const boxes = containerEl.querySelectorAll('.box3[data-place]');
  boxes.forEach(box=>{
    const oldEl = box.querySelector('[data-role="old"]');
    const midEl = box.querySelector('[data-role="mid"]');
    const newEl = box.querySelector('[data-role="new"]');

    if (oldEl) oldEl.classList.remove('strike');
    if (midEl){ midEl.classList.add('hidden'); midEl.textContent=''; }
    if (newEl){ newEl.classList.add('hidden'); newEl.textContent=''; }
  });
}

function setTopDigits(containerEl, d){
  const map = {h:d.h, t:d.t, o:d.o};
  ['h','t','o'].forEach(p=>{
    const box = containerEl.querySelector(`[data-place="${p}"]`);
    if (!box) return;
    const oldEl = box.querySelector('[data-role="old"]');
    if (oldEl) oldEl.textContent = toArabic(map[p]);
  });
}
function resetGridToOriginal(containerEl, q){
  // ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ÙƒÙ…Ø§ ÙƒØ§Ù†Øª (Ù‚Ø¨Ù„ Ø£ÙŠ Ø´Ø·Ø¨/Ø¹Ù„Ø§Ù…Ø§Øª)
  resetMarks(containerEl);
  setTopDigits(containerEl, {h:q.h1, t:q.t1, o:q.o1});
}


// ÙŠØ¨Ù†ÙŠ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ø±Ø­)
function buildBorrowFrames(top, bot){
  let h = Math.floor(top/100), t = Math.floor((top%100)/10), o = top%10;
  const t2 = Math.floor((bot%100)/10), o2 = bot%10;

  const frames = [];

  // 1) Ø§Ø³ØªÙ„Ø§Ù Ù„Ù„Ø¢Ø­Ø§Ø¯
  if (o < o2){
    if (t === 0){
      const before = {h,t,o};
      const after  = {h:h-1, t:t+10, o};
      frames.push({
        before, after,
        text: `Ø§Ù„Ø¢Ø­Ø§Ø¯ ${toArabic(o)} Ø£ØµØºØ± Ù…Ù† ${toArabic(o2)} ÙˆØ§Ù„Ø¹Ø´Ø±Ø§Øª = ${toArabic(0)} â†’ Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª: Ø§Ù„Ù…Ø¦Ø§Øª ${toArabic(after.h)} ÙˆØ§Ù„Ø¹Ø´Ø±Ø§Øª ${toArabic(after.t)}.`
      });
      h = after.h; t = after.t;
    }
    {
      const before = {h,t,o};
      const after  = {h, t:t-1, o:o+10};
      frames.push({
        before, after,
        text: `Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù„Ù„Ø¢Ø­Ø§Ø¯ â†’ Ø§Ù„Ø¹Ø´Ø±Ø§Øª ${toArabic(after.t)} ÙˆØ§Ù„Ø¢Ø­Ø§Ø¯ ${toArabic(after.o)}.`
      });
      t = after.t; o = after.o;
    }
  }

  // 2) Ø§Ø³ØªÙ„Ø§Ù Ù„Ù„Ø¹Ø´Ø±Ø§Øª (Ø¨Ø¹Ø¯ Ø¶Ø¨Ø· Ø§Ù„Ø¢Ø­Ø§Ø¯)
  if (t < t2){
    const before = {h,t,o};
    const after  = {h:h-1, t:t+10, o};
    frames.push({
      before, after,
      text: `Ø§Ù„Ø¹Ø´Ø±Ø§Øª ${toArabic(t)} Ø£ØµØºØ± Ù…Ù† ${toArabic(t2)} â†’ Ù†Ø³ØªÙ„Ù Ù¡ Ù…Ù† Ø§Ù„Ù…Ø¦Ø§Øª: Ø§Ù„Ù…Ø¦Ø§Øª ${toArabic(after.h)} ÙˆØ§Ù„Ø¹Ø´Ø±Ø§Øª ${toArabic(after.t)}.`
    });
  }

  return frames;
}

function setStepButtons(){
  const btnStep = document.getElementById('btnStep');
  const btnBack = document.getElementById('btnBack');
  if (!btnStep || !btnBack) return;

  if (!borrowStepper){
    btnStep.textContent = 'Ø®Ø·ÙˆØ© Ø®Ø·ÙˆØ©';
    btnStep.disabled = false;
    btnBack.disabled = true;
    btnBack.style.opacity = .55;
    return;
  }

  const len = borrowStepper.frames.length;
  const st  = borrowStepper.stage;

  // Back
  btnBack.disabled = (st === 0);
  btnBack.style.opacity = btnBack.disabled ? .55 : 1;

  // Step text
  if (len === 0){
    btnStep.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³ØªÙ„Ø§Ù';
  } else if (st === 0){
    btnStep.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø®Ø·ÙˆØ§Øª';
  } else if (st < len){
    btnStep.textContent = 'Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©';
  } else {
    btnStep.textContent = 'Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ù„';
  }
}

function renderBorrowStage(stage){
  const grid = document.getElementById('practiceProblem');
  const q = state.q;

  // Ø§Ø±Ø¬Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø§Øª (Ø§Ù„Ù‚Ø¯ÙŠÙ…)
  resetMarks(grid);
  setTopDigits(grid, {h:q.h1, t:q.t1, o:q.o1});

  if (!borrowStepper) return;

  const frames = borrowStepper.frames;

  // Ø§Ø¬Ù…Ø¹ ØªØºÙŠÙ‘Ø±Ø§Øª ÙƒÙ„ Ø®Ø§Ù†Ø© Ø­ØªÙ‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
  const changes = {h:[], t:[], o:[]};
  for (let i=0; i<stage; i++){
    const fr = frames[i];
    ['h','t','o'].forEach(p=>{
      if (fr.before[p] !== fr.after[p]) changes[p].push(fr.after[p]);
    });
  }

  function drawPlace(place){
    const box = grid.querySelector(`[data-place="${place}"]`);
    if (!box) return;
    const oldEl = box.querySelector('[data-role="old"]');
    const midEl = box.querySelector('[data-role="mid"]');
    const newEl = box.querySelector('[data-role="new"]');

    const arr = changes[place];

    if (arr.length === 0) return;

    // Ø´Ø·Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
    if (oldEl) oldEl.classList.add('strike');

    if (arr.length === 1){
      // Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø©: ØªØ¸Ù‡Ø± ÙƒØ±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…Ø´Ø·ÙˆØ¨)
      if (newEl){
        newEl.textContent = toArabic(arr[0]);
        newEl.classList.remove('hidden');
      }
    } else {
      // Ù‚ÙŠÙ…ØªØ§Ù† Ø£Ùˆ Ø£ÙƒØ«Ø±: Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙØ¹Ø±Ø¶ ÙƒÙˆØ³ÙŠØ· (Ù…Ø´Ø·ÙˆØ¨) ÙˆØ§Ù„Ø£Ø®ÙŠØ±Ø© ÙƒØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      if (midEl){
        midEl.textContent = toArabic(arr[0]);
        midEl.classList.remove('hidden');
      }
      if (newEl){
        newEl.textContent = toArabic(arr[arr.length-1]);
        newEl.classList.remove('hidden');
      }
    }
  }

  ['h','t','o'].forEach(drawPlace);

  // ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©
  const len = frames.length;
  if (len === 0){
    setFeedback('âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³ØªÙ„Ø§Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø©.', 'good');
    return;
  }

  if (stage === 0){
    setFeedback('Ø§Ø¶ØºØ·ÙŠ <b>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø®Ø·ÙˆØ§Øª</b> Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ø®Ø·ÙˆØ© Ø®Ø·ÙˆØ©.', 'good');
  } else if (stage <= len){
    const fr = frames[stage-1];
    setFeedback(
      `<div class="font-extrabold text-slate-800 mb-2">Ø®Ø·ÙˆØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù (${toArabic(stage)} / ${toArabic(len)})</div>
       <div class="leading-7">${fr.text}</div>`,
      'good'
    );
  }
}

function resetBorrowStepper(){
  borrowStepper = null;
  setStepButtons();
}

function initBorrowStepper(){
  const frames = buildBorrowFrames(state.q.top, state.q.bot);
  borrowStepper = {
    frames,
    stage: 0,
    top: state.q.top,
    bot: state.q.bot
  };
  renderBorrowStage(0);
  setStepButtons();
}

function stepNextBorrow(){
  if (!borrowStepper || borrowStepper.top !== state.q.top || borrowStepper.bot !== state.q.bot){
    initBorrowStepper();
    return;
  }

  const len = borrowStepper.frames.length;

  if (len === 0){
    setFeedback('âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³ØªÙ„Ø§Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø©. Ø¬Ø±Ù‘Ø¨ÙŠ Ø³Ø¤Ø§Ù„Ù‹Ø§ Ø¢Ø®Ø±.', 'good');
    return;
  }

  if (borrowStepper.stage < len){
    borrowStepper.stage += 1;
    renderBorrowStage(borrowStepper.stage);
    setStepButtons();
  } else {
    // Ø§Ù†ØªÙ‡Øª Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù â†’ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„ Ø§Ù„ÙƒØ§Ù…Ù„
    showSolution();
    resetBorrowStepper();
  }
}

function stepPrevBorrow(){
  if (!borrowStepper || borrowStepper.top !== state.q.top || borrowStepper.bot !== state.q.bot){
    initBorrowStepper();
    return;
  }

  if (borrowStepper.stage > 0){
    borrowStepper.stage -= 1;
    renderBorrowStage(borrowStepper.stage);
    setStepButtons();
  }
}

    function stepsHtml(q){
      const lines = q.log.map((s)=>`<li class="mb-2">${s}</li>`).join('');
      return `
        <div class="text-right leading-8 text-slate-700">
          <div class="mb-2 font-extrabold text-slate-800">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</div>
          <ol class="list-decimal pr-6">${lines}</ol>
          <div class="mt-3 p-3 rounded-2xl bg-emerald-50 border border-emerald-200 font-extrabold text-emerald-800">
            Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span dir="ltr">${toArabic(q.rHundreds)}${toArabic(q.rTens)}${toArabic(q.rOnes)}</span>
          </div>
        </div>
      `;
    }

    // Example
    let exQ = gen('zerosBorrow');
    function renderExample(){
  // 1) Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© (Ù†ØµÙŠØ§Ù‹)
  document.getElementById('exampleEq').innerHTML = `
    <div class="text-slate-700 font-bold">Ø§Ù„Ù…Ø³Ø£Ù„Ø©:</div>
    <div class="flex items-center gap-4" dir="rtl">
      <span class="text-2xl font-extrabold text-slate-800">${toArabic(exQ.top)}</span>
      <span class="text-3xl font-extrabold text-pink-600">âˆ’</span>
      <span class="text-2xl font-extrabold text-slate-800">${toArabic(exQ.bot)}</span>
    </div>
  `;

  // 2) Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª (Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹)
  renderProblem('exampleGrid', exQ, {prefix:'ex', showBorrowInputs:false});
  applyBorrowToGrid(document.getElementById('exampleGrid'), exQ.work);

  // 3) Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„
  document.getElementById('exampleSteps').innerHTML = stepsHtml(exQ);
}

    document.getElementById('btnNewExample').onclick = ()=>{ exQ = gen('zerosBorrow'); renderExample(); };
    renderExample();

    // Practice state
    let state = { q: gen('zerosBorrow'), score:0, total:0 };

    function updateScore(){
      document.getElementById('score').textContent = toArabic(state.score);
      document.getElementById('total').textContent = toArabic(state.total);
    }
    updateScore();

    function setFeedback(html, kind){
      const box = document.getElementById('feedback');
      box.classList.remove('shake','pop');
      void box.offsetWidth;
      box.classList.add(kind==='good' ? 'pop' : 'shake');
      box.innerHTML = html;
    }

    function clearAnswer(){
      ['ans-h','ans-t','ans-o'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      const bh=document.getElementById('pr-borrow-h'); if(bh) bh.value='';
      const bt=document.getElementById('pr-borrow-t'); if(bt) bt.value='';
      const mh=document.getElementById('pr-borrow-h-msg'); if(mh) mh.innerHTML='';
      const mt=document.getElementById('pr-borrow-t-msg'); if(mt) mt.innerHTML='';


    }

    function attachAnswerBehaviors(){
      const ids=['ans-h','ans-t','ans-o'];
      ids.forEach((id, idx)=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', ()=>{
          const raw = normDigits(el.value).replace(/\D/g,'');
          if (raw.length>=2){
            const last3 = raw.slice(-3).padStart(3,'0');
            document.getElementById('ans-h').value = last3[0];
            document.getElementById('ans-t').value = last3[1];
            document.getElementById('ans-o').value = last3[2];
            document.getElementById('ans-o').focus();
            return;
          }
          el.value = raw.slice(-1);
          if (el.value && idx<ids.length-1) document.getElementById(ids[idx+1]).focus();
        });
        el.addEventListener('keydown', (e)=>{
          if (e.key==='Backspace' && !el.value && idx>0) document.getElementById(ids[idx-1]).focus();
          if (e.key==='Enter') checkAnswer();
        });
      });
    }

function renderPractice(){
  renderProblem('practiceProblem', state.q, {prefix:'pr', showBorrowInputs:true});
  attachAnswerBehaviors();

  // âœ… ØªÙ…Ø±ÙŠÙ† Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù (Ù…Ø¦Ø§Øª/Ø¹Ø´Ø±Ø§Øª)
  attachBorrowTrainer('pr', state.q);

  const h = document.getElementById('ans-h');
  if (h) h.focus();
}

    renderPractice();

    function readAnswer(){
      const h=normDigits(document.getElementById('ans-h').value).replace(/\D/g,'').slice(-1);
      const t=normDigits(document.getElementById('ans-t').value).replace(/\D/g,'').slice(-1);
      const o=normDigits(document.getElementById('ans-o').value).replace(/\D/g,'').slice(-1);
      if(h===''||t===''||o==='') return {ok:false, value:null};
      return {ok:true, value: parseInt(`${h}${t}${o}`,10)};
    }

    function checkAnswer(){
      const ans = readAnswer();
      if(!ans.ok){
        setFeedback('âš ï¸ Ø§ÙƒØªØ¨ÙŠ ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ù…Ø±Ø¨Ø¹Ù‡ (Ù…Ø¦Ø§Øª/Ø¹Ø´Ø±Ø§Øª/Ø¢Ø­Ø§Ø¯).', 'bad');
        return;
      }
      state.total += 1;
      const correct = ans.value === state.q.answer;
      if(correct) state.score += 1;
      updateScore();
      const borrowOk = updateBorrowHints('pr', state.q);
      if(correct){
  const extra = borrowOk ? '' : `<div class="mt-2 text-amber-700 font-bold">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù†Ø§ØªØ¬ ØµØ­ÙŠØ­ âœ… Ù„ÙƒÙ† Ø±Ø§Ø¬Ø¹ÙŠ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>`;
  setFeedback(`<div class="font-extrabold text-emerald-700 text-lg">Ø£Ø­Ø³Ù†ØªÙ! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ğŸ‰</div>
    <div class="mt-2"><b>Ø§Ù„Ù†Ø§ØªØ¬:</b> ${toArabic(state.q.answer)}</div>${extra}`, 'good');
      } else {
        setFeedback(`<div class="font-extrabold text-rose-700 text-lg">Ø­Ø§ÙˆÙ„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ’¡</div>
          <div class="mt-2"><b>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</b> ${toArabic(ans.value)}</div>
          <div><b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> ${toArabic(state.q.answer)}</div>
          <div class="mt-3 p-4 rounded-2xl bg-amber-50 border border-amber-200">${stepsHtml(state.q)}</div>`, 'bad');
          const grid = document.getElementById('practiceProblem');
          applyBorrowToGrid(grid, state.q.work);
      }
    }

    function showSolution(){
  const grid = document.getElementById('practiceProblem');
  resetGridToOriginal(grid, state.q);
  applyBorrowToGrid(grid, state.q.work);
  updateBorrowHints('pr', state.q, {reveal:true});
  showBorrowArrows(grid, state.q);

  setFeedback(`<div class="font-extrabold text-slate-800 mb-2">Ø§Ù„Ø­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©</div>${stepsHtml(state.q)}`, 'good');
}




    function newQuestion(){
     const mode = document.getElementById('mode').value;
     state.q = gen(mode);
     clearAnswer();
     renderPractice();
     resetBorrowStepper(); // âœ… Ù…Ù‡Ù…
     setFeedback('Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù†Ø§ØªØ¬ Ø«Ù… Ø§Ø¶ØºØ·ÙŠ <b>ØªØ­Ù‚Ù‚</b>. ØªØ°ÙƒØ±ÙŠ: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ø´Ø±Ø§Øª = Ù  Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù Ø¹Ø¨Ø± Ø§Ù„ØµÙØ±.', 'good');
    }

    document.getElementById('btnCheck').onclick = checkAnswer;
    document.getElementById('btnSolve').onclick = showSolution;
    document.getElementById('btnNewQ').onclick = newQuestion;
    document.getElementById('mode').onchange = newQuestion;
    document.getElementById('btnStep').onclick = stepNextBorrow;
    document.getElementById('btnBack').onclick = stepPrevBorrow;

    setTab('tab-learn');
  </script>
</body>
</html>
